<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>c128lib Framework: Framework</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">c128lib Framework
   </div>
   <div id="projectbrief">A Commodore 128 software framework for enabling high-level development of C128 programs.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Framework </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2github_2workspace_2README"></a>A Commodore 128 software framework for enabling high-level development of C128 programs.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Z80 code integration</h1>
<p>Starting with v0.2.0 (still unreleased) are available some macros for Z80 code integration. Macros will help developers to setup Z80 code and prepare programs to start execution.</p>
<p><b>The code for Z80 will not run in parallel with the code for 8502</b> but there will only be preemptive multitasking. To understand mechanism for Z80 and 8502 switchover <a href="https://intoinside.github.io/2023/07/07/running-z80/">look at this post</a>.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Macros</h2>
<p>There are two kind of macros:</p><ul>
<li><a class="el" href="z80-global_8asm.html#ac1f9b45ca35f2e78e6a0ae81b1d6d2db">c128lib_PreZ80Code()</a> and <a class="el" href="z80-global_8asm.html#adb07df26bec72ab6f35b23705cdc6359">c128lib_PostZ80Code()</a></li>
<li><a class="el" href="z80-global_8asm.html#a0b7485e3c32f393f66636aeb2fd8a328" title="Z80 related macros.">c128lib_RunZ80Code(z80CodeAddress)</a></li>
</ul>
<p>The first two macros are needed to <em>decorate</em> your Z80 code (setup Mmu at start and jmp to bootlink routine at the end to consent 8502 restart). They must be called before and after your Z80 code.</p>
<p>The last macro will prepare environment to start Z80 code execution and handles return from z80 code.</p>
<p>Here an example of entry point to call Z80 code:</p>
<pre><code>
c128lib_BasicUpstart128($2000)

* = $2000 "Entry"
Entry: {
  // Some code executed on 8502

  <a class="el" href="z80-global_8asm.html#a0b7485e3c32f393f66636aeb2fd8a328" title="Z80 related macros.">c128lib_RunZ80Code(z80CodeAddress)</a>

  // Other code executed on 8502

  rts
}
</code></pre><p>Then, you can define an area (called z80CodeAddress on the example above) and call macros to decorate it:</p>
<pre><code>
* = * "z80CodeAddress"
z80CodeAddress:
  <a class="el" href="z80-global_8asm.html#ac1f9b45ca35f2e78e6a0ae81b1d6d2db">c128lib_PreZ80Code()</a>

  .byte $3E, $08        // LD A, #$08   -- load up the #$08 (H) byte
  .byte $32, $00, $04   // LD ($0400),A -- write on screen
  .byte $3C             // INC A
  .byte $32, $01, $04   // LD ($0401),A -- write on screen
  .byte $3E, $21        // LD A, #$21   -- load up the #$21 (!) byte
  .byte $32, $02, $04   // LD ($0402),A -- write on screen

  <a class="el" href="z80-global_8asm.html#adb07df26bec72ab6f35b23705cdc6359">c128lib_PostZ80Code()</a>
</code></pre><p>If you run this script, you'll see "HI!" printed on the 40 col screen by Z80 processor. At this time, z80 code must be written as a byte sequence of machine language instruction. I hope I can change that soon.</p>
<p>PS: i'm not an expert of z80 code... so that code it's quite stupid, probably not optimized etc..., take it just as an example.</p>
<p>I suggest to use <a href="http://www.grauw.nl/projects/glass/">GlassZ80</a> as assembler to generate machine language code. Code can be assembled on external file and imported with <em>.import binary "file"</em> to make code more readable and separate concerns. Z80 code can be assembled like:</p>
<pre>java -jar glass.jar test.zasm test.bin</pre><p>and then importing with:</p>
<pre>.import binary "test.bin"</pre> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sun Sep 10 2023 18:33:18 for c128lib Framework by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
